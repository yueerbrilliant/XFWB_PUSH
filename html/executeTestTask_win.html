<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <style>
          .text-light {
              color: #999 !important;
          }
          .aui-radio {
              width: 1rem;
              height: 1rem;
          }
          .floatleft{
            float: left;
          }
          .text-input-form{
              border: 1px solid #CCC;
              border-radius: 5px;
              background-color: #FFF;
          }
          .input-form-top{
              position: relative;
              height: 30px;
              border-bottom: 1px solid #CCC;
          }
          .input-form-bottom{
              position: relative;
              height: 30px;
          }
          .tips-style{
            font-size: 14px;
            font-family: "微软雅黑";
            color: "#F00";
          }
          .aligncenter {
            clear: both;
            display: block;
            margin:auto;
            }
            .serial-num{
    font-size: 30px;
            }
    </style>
</head>
<body>
    <header class="aui-bar aui-bar-nav" id="aui-header">
        <a class="aui-btn aui-pull-left" tapmode onclick="closeWin()">
            <span class="aui-iconfont aui-icon-left"></span>
        </a>
        <div class="aui-title">测试任务</div>
    </header>


    <section id="section" class="aui-content">
        <div class="aui-card-list">
            <div id ="facility_name" class="aui-card-list-header aui-font-size-14">
                <!-- <div>
                  设施名称：报警控制器
                </div> -->
                <!-- <div style="margin-right:40%;">
                    报警控制器
                </div> -->
            </div>
            <div id="maintenance_content" class="aui-card-list-header aui-font-size-14">
                <!-- <div>
                  维保内容:b.试验电源主部分
                </div> -->
                <!-- <div style="margin-right:30%;">
                    b.试验电源主部分
                </div> -->
            </div>
        </div>
        <!--下面是列表，填东西-->

        <ul id="control_ul0" class="aui-list aui-select-list">

            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                    当你看到这行文字的时候，表示服务器出现了问题,请联系管理员:
                </div>
            </li>
            <li  class="aui-list-item">
                <div id ="accessdiv"+count class="aui-list-item-inner">
                    <label><input id="accessyes"+count class="aui-radio" type="radio" name="access" > 服务器出现问题</label>
                    <label><input id="accessno"+count class="aui-radio" type="radio" name="access"> 服务器出现问题</label>
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                    当你看到这行文字的时候，表示服务器出现了问题,请联系管理员:
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                  <div class="text-input-form">
                      <div class="input-form-top clearfix">
                          <input id="normalratio"+count type="text" style="height:30px;">
                      </div>
                  </div>
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                    服务器出现问题:
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                  <div class="text-input-form">
                      <div class="input-form-top clearfix">
                          <input id= "exceptionratio"+count type="text" style="height:30px;">
                      </div>
                  </div>
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                  <div style="color:#F00"> (服务器出现问题)</div>
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner" align="center">
                      <img class="aligncenter" src="../image/plus.jpg" height="40"  width="40" onclick="fnOpenChooseFrame()">
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                      <img id="voice"+count style="float:left;margin-left:35px;" src="../image/plus.jpg" height="30"  width="30" >
                      <img id="text"+count  style="float:left;margin-left:35px;" src="../image/plus.jpg" height="30"  width="30" >
                      <img id="video"+count style="float:left;margin-left:35px;" src="../image/plus.jpg" height="30"  width="30">
                      <img id="image"+count style="float:left;margin-left:35px;" src="../image/plus.jpg" height="30"  width="30">
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                  测试结果
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                  <label><input id="normal"+count class="aui-radio" type="radio" name="testresult" > 正常</label>
                  <label><input id="repair"+count class="aui-radio" type="radio" name="testresult"> 需要维修报价</label>
                  <label><input id="investigation"+count class="aui-radio" type="radio" name="testresult" > 需要进一步排查</label>
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                  <img class="aligncenter" src="../image/delete.png" height="40"  width="40" onclick="deletecontent()">
                </div>
            </li>
        </ul>
    </section>
    <div>
    <footer class="aui-bar aui-bar-tab" id="footer">
        <div class="aui-bar-tab-item aui-padded-l-15 aui-padded-r-15">
            <div>
                <div style="width:40%;padding:0;margin:0;float:left;box-sizing:border-box;">
                    <div class="aui-btn aui-btn-block aui-btn-sm aui-btn-info " onclick="submitTask()"><i class="aui-iconfont aui-font-size-16"></i>提交任务</div>
                </div>
                <div style="width:40%;padding:0;margin:0;float:right;box-sizing:border-box;">
                    <div class="aui-btn aui-btn-block aui-btn-sm aui-btn-info" onclick="addTask()"><i class="aui-iconfont aui-font-size-16"></i>添加下一个</div>
                </div>
            </div>
        </div>
    </footer>
  </div>
  <canvas id="mycanvas"style="display:none"></canvas>
</body>


<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/jquery-1.4.2.min.js"></script>
<script type="text/javascript">
    var count = 0;
    var textcontent=new Array();
    var photocontent=new Array();
    var videocontent=new Array();
    var voicecontent=new Array();
    var cannottest = new Array();
    var task_id="";
    var maintenance_test_content_id="";
    var maintenanceplan_id = "";
    var userName="";
    var clickChoose = false;
    var allinformation="";
    var dialogBox;
    var photoBrowser;
    apiready = function(){
      photoBrowser = api.require('photoBrowser');
       api.parseTapmode();
       dialogBox= api.require('dialogBox');
       task_id  = api.pageParam.task_id;
       maintenance_test_content_id = api.pageParam.maintenance_test_content_id;
       maintenanceplan_id = api.pageParam.maintenanceplan_id;
       userName = $api.getStorage('name');
       getALLinformation();
       api.addEventListener({
       　　　　name: 'keyback'
       　　}, function(ret, err) {
       　　　　photoBrowser.close();
       　　});
    };

    //getALLinformation
    //creatPage();


    function closeWin(){
      // api.sendEvent({
      //      name: 'msg_name',
      //      extra:{ "status":"true" }
      // });

        api.closeWin({
        });
    }

    function submitTask()
    {
      //把所有数据组装json，统一提交
      getPicturecount();
      var submit_json = {};
      var data = eval(allinformation);
      var control_content = eval(data.control_content);
      var json_array = [];
      for (var i = 0; i <= count; i++) {
        //项目的序号为i+1，这里转成int
        var i_int = parseInt(i)+1;
        //没拍照，警告，不能提交
        if (photocontent[i]=="") {
          alert("你的第"+i_int+"项照片未提交，请拍照");
          return;
        }
        //测试结果那一栏没填写，警告，不能提交
        var temp_result = document.getElementsByName('testresult'+i);
        var bFlags=false;
        for (var tt = 0; tt < temp_result.length; tt++) {
           if (temp_result[tt].checked) {
             bFlags = true;
             break;
           }
        }
        if (bFlags == false) {
           alert("你的第"+i_int+"项的测试结果未选择，请选择");
           return;
        }
        var item_name = "item_"+i_int;
        var item_array=[];
        var temp_json = {};
         for (var j=0;j<control_content.length;j++) {
           var tempcontrol = control_content[j];
           if (tempcontrol.control_type=="radio") {
             //得出radio的name，然后用name判断这个的radio是否选择过，没有的话break返回;
              var temp_radio_name = tempcontrol.control_name;
              var temp_result = document.getElementsByName(temp_radio_name+i);
              var bFlags=false;
              for (var tt = 0; tt < temp_result.length; tt++) {
                 if (temp_result[tt].checked) {
                   bFlags = true;
                   break;
                 }
              }
              if (bFlags == false) {
                 alert("你的第"+i_int+"项的内容未全部填写，请补充完整");
                 return;
              }

             //首先判断这个是不是“能测试”这个radio  是的话直接添加text，不是的话，需要用函数findTextByName来找到它的test
             if (tempcontrol.control_name=='test') {
              //这个radio是  能否测试，直接可以得到前面的文字和结果
              var temp_text  = "能否测试";
              var temp_id = tempcontrol.control_id+i;
              var radio = document.getElementById(temp_id);
              if (radio.checked&&radio.value=='不能测试') {
                var testnotxt = cannottest[i];
                temp_json={"name":"能否测试","value":"不能测试"};
                item_array.push(temp_json);
                temp_json={"name":"不能测试原因","value":testnotxt};
                item_array.push(temp_json);
                break;
               }
               else {
                 if (radio.checked&&radio.value=='能测试')
                 {
                   temp_json={"name":"能否测试","value":"能测试"};
                   item_array.push(temp_json);
                 }
              }
             }
            else {
              //这个radio不是能否测试项，那么就采用复杂的流程，先找到它选中的json的值，然后找到它的text，组装成json
              var temp_id = tempcontrol.control_id+i;
              //通过name属性来查找到相应的text名称,函数有问题
              var temp_text = findTextByName(tempcontrol.control_name);
              var radio = document.getElementById(temp_id);
              if (radio.checked) {
                //alert(radio.value);
                temp_json={"name":temp_text,"value":radio.value};
                item_array.push(temp_json);
              }
            }
          }

           else {
             //这是后加的，判断点击提交时input里面是否有内容的代码

             //如果是input的话，找到对应的txt，然后获取input的val()，组装
                 if (tempcontrol.control_type=='input') {
                   var temp_text_id = tempcontrol.control_id+i;

                   if (document.getElementById(temp_text_id).value=="")
                   {
                     alert("你的第"+i_int+"项的内容未全部填写，请补充完整");
                     return;
                   }
                   var temp_id = tempcontrol.control_id+i;
                    var input_value = document.getElementById(temp_id).value;
                    var input_text = findTextByName(tempcontrol.control_name);
                    temp_json={"name":input_text,"value":input_value};
                    item_array.push(temp_json);
                //    temp_json[input_text] = input_value;
                 }
           }
         }//j

        //
        // //最后塞入相应的文字、视频、语音、拍照和测试结果
        // //注意某个可能为空
        temp_json={"name":"文字","value":textcontent[i]};
        item_array.push(temp_json);
        temp_json={"name":"视频","value":videocontent[i]};
        item_array.push(temp_json);
        temp_json={"name":"语音","value":voicecontent[i]};
        item_array.push(temp_json);
        //图片涉及到一个文件上传的操作
        temp_json={"name":"照片","value":photocontent[i]};
        item_array.push(temp_json);
         var test_result = document.getElementsByName('testresult'+i);
         for (var l = 0; l < test_result.length; l++) {
          if(test_result[l].checked)
          {
            temp_json={"name":"测试结果","value":test_result[l].value};
            item_array.push(temp_json);
              //temp_json["测试结果"] = test_result[l].value;
          }
        }//for l

        var item_json = {};
        item_json[item_name]= item_array;
        json_array.push(item_json);

      }//for i
      submit_json['detail_content'] = json_array;

      //下面把这个json转换成字符串，替换掉[]{}等特殊符号后，传递
      var task_item_json = JSON.stringify(submit_json);

      //后面调用接口，把传到后台
      api.showProgress({
      title: '提交中...',
      text: '先喝杯茶...',
      modal: false
      });
      api.ajax({
          url: $api.getStorage('connectUrl') + '/Maintenancer/SubmitTaskItem',//接口地址
          method: 'post',
          dataType:'json',
          data: {
              values: {
                  maintenance_test_content_id:maintenance_test_content_id,
                  maintenanceplan_id:maintenanceplan_id,
                  task_id:task_id,
                  task_item_json:task_item_json
              },
              files:files1
      //         files: {
      //      "photo": "fs://img/"+pictureid+".png",
      //  }
          }
      },function(ret, err){
        //alert(JSON.stringify(ret));
        api.hideProgress();
          if (ret) {
            var status = ret.status;
            //alert(JSON.stringify(ret));
               if (status == "true") {
                 alert("提交成功");
                 api.sendEvent({
                      name: 'msg_name',
                      extra:{ "status":"true" }
                 });
                 api.closeWin({
                     name: 'executeTestTask_win'
                 });

               }
               else {
                 alert("提交失败");
                 api.toast({
                     msg: ret.message,
                     duration: 2000,
                     location: 'bottom'
                 });
               }
          } else {
            console.log(JSON.stringify(err));
            alert("未能与服务器连接");
            api.toast({
                msg: err.message,
                duration: 2000,
                location: 'bottom'
            });
          }
      });
      // api.closeWin({
      //     name: 'executeTestTask_win'
      // });
    }

function findTextByName (name){
  //一个用来从控件获取它说明性文字的函数
  var data = eval(allinformation);
  var control_content = eval(data.control_content);
  for (var i=0;i<control_content.length;i++) {
    var tempcontrol = control_content[i];
    if (tempcontrol.control_type=='text'&&tempcontrol.control_name==name) {
      return tempcontrol.control_value;
    }
  }
}


function addTask(){
    //添加下一项的响应函数
      count++;
      var num = count;
      textcontent[num]="";
      videocontent[num]="";
      voicecontent[num]="";
      photocontent[num]="";
      cannottest[num]="";
      alert("您点击了添加下一项");
      var new_ul = '<ul id="control_ul'+num+'" class="aui-list aui-select-list"></ul>';
      $("#section").append(new_ul);
      num_int = parseInt(num)+1;
      var serial_number = '<li class="aui-list-item" style="font-size:24px;">'+num_int+'</li>';
      $("#control_ul"+num).append(serial_number);
      var data = eval(allinformation);
      var alert_content = data.alert_content;
      var control_content = eval(data.control_content);
      for (var i = 0; i < control_content.length; i++) {
        var tempcontrol = control_content[i];
        if (tempcontrol.control_type=="radio") {
          //判断这个radio的上层控件之前是否写过
          var isexist = tempcontrol.control_name+'div'+num;

          if (document.getElementById(isexist)) {
            var tempcontrol_html = '<label><input id="'+tempcontrol.control_id+num+'" class="aui-radio" type="radio" name="'+tempcontrol.control_name+num+'" value="'+tempcontrol.control_value+'"> '+tempcontrol.control_value+'</label>';
             $("#"+isexist).append(tempcontrol_html);

          }
          else {
            var tempcontrol_html = '<li class="aui-list-item"><div id ="'+tempcontrol.control_name+'div'+num+'" class="aui-list-item-inner"><label><input id="'+tempcontrol.control_id+num+'" class="aui-radio" type="radio" name="'+tempcontrol.control_name+num+'" value="'+tempcontrol.control_value+'" > '+tempcontrol.control_value+'</label></div></li>';
              $("#control_ul"+num).append(tempcontrol_html);
          }
        }
        else {
              if (tempcontrol.control_type=="text")
              {
                var temptexthtml =  '<li class="aui-list-item"><div class="aui-list-item-inner" style="color:'+tempcontrol.control_color+'" name="'+tempcontrol.control_name+num+'">'+tempcontrol.control_value+':</div></li>'
                 $("#control_ul"+num).append(temptexthtml);
              }
              else
              {
                  if (tempcontrol.control_type=="input") {
                      var tempinputhtml = '<div class="aui-list-item-inner"><div class="text-input-form"><div class="input-form-top clearfix"><input id= "'+tempcontrol.control_id+num+'" type="text" style="height:30px;"></div></div></div>';
                     $("#control_ul"+num).append(tempinputhtml);
                  }
                  else {
                    alert("数据好像有问题，这个数据没法解析");
                  }
              }
        }

      }//for
      var  tempalert_content = '<li class="aui-list-item"><div class="aui-list-item-inner" style="color:#F00;">'+alert_content+':</div></li>';
      $("#control_ul"+num).append(tempalert_content);
      var  tempother = '<li class="aui-list-item"><div class="aui-list-item-inner" align="center"><img class="aligncenter" src="../image/arrows_circle_plus.png" height="40"  width="40" onclick="fnOpenChooseFrame('+num+')"></div></li><li class="aui-list-item"><div class="aui-list-item-inner"><img id="voice'+num+'" style="float:left;margin-left:35px;" src="../image/voice.ico" height="30"  width="30" ><img id="text'+num+'"  style="float:left;margin-left:35px;" src="../image/word.ico" height="30"  width="30" ><img id="video'+num+'" style="float:left;margin-left:35px;" src="../image/video.ico" height="30"  width="30"><img id="image'+num+'" style="float:left;margin-left:35px;" src="../image/Photo.ico" height="30"  width="30" onclick="fnOpenpicture('+num+')"></div></li><li class="aui-list-item"><div class="aui-list-item-inner">测试结果</div></li><li class="aui-list-item"><div class="aui-list-item-inner"><label><input id="normal'+num+'" class="aui-radio" type="radio" name="testresult'+num+'" value="正常" > 正常</label><label><input id="repair'+num+'" class="aui-radio" type="radio" name="testresult'+num+'" value ="需要报价维修"> 需要维修报价</label><label><input id="investigation'+num+'" class="aui-radio" type="radio" name="testresult'+num+'" value="需要进一步排查" > 需要进一步排查</label></div></li><li class="aui-list-item"><div class="aui-list-item-inner"><img class="aligncenter" src="../image/delete.png" height="40"  width="40" onclick="deletecontent('+num+')"></div></li><li class="aui-list-item"><div class="aui-list-item-inner"></div></li>';
      $("#control_ul"+num).append(tempother);
      $("#testno"+num).click(function(){

          dialogBox.list({
              tapClose: true,
              texts: {
                  title: '请填写不能测试的原因',
                  enter: '提交'
              },
              listTitles: [''],
              styles: {
                  bg: '#fff',
                  corner: 0,
                  w: 300,
                  h: 260,
                  title: {
                      h: 44,
                      size: 14,
                      color: '#000'
                  },
                  list: {
                      h: 60,
                      row: 1,
                      title: {
                          marginL: 10,
                          size: 14,
                          color: '#696969'
                      },
                      content: {
                          marginL: 10,
                          size: 14,
                          color: '#000'
                      }
                  },
                  dividingLine: {
                      width: 0.5,
                      color: '#696969'
                  },
                  enter: {
                      w: 135,
                      h: 55,
                      bg: '#F00',
                      color: '#ffffff',
                      size: 20
                  }
              }
          }, function(ret) {
              if (ret.eventType == 'enter') {
                  cannottest[num]  = ret.amounts;
                  dialogBox.close({
                      dialogName: 'list'
                  });
                  //本项不能测试，把除了不能测试以外的控件全部清零，然后
                  alert("本项不能测试，请继续测试工作，在完成所有测试项后点击提交按钮");

                //
                $("#control_ul"+num).html("");
                num_int = parseInt(num)+1;
                var serial_number = '<li class="aui-list-item" style="font-size:24px;">'+num_int+'</li>';
                $("#control_ul"+num).append(serial_number);

                var tempcontrol_html = '<li class="aui-list-item"><div id ="testdiv'+num+'" class="aui-list-item-inner"><label><input id="testyes'+num+'" class="aui-radio" type="radio" name="test'+num+'" value="能测试" > 能测试</label><label><input id="testno'+num+'" class="aui-radio" type="radio" name="test'+num+'" value="不能测试" checked disabled>不能测试</label></div></li>';
                $("#control_ul"+num).append(tempcontrol_html);
                //需要个li标签来填充一下位置
                var tianchong = '<li class="aui-list-item"></li>';
                $("#control_ul"+num).append(tianchong);
              }
          });

      });
    }


function creatPage(){
      //这个函数是用来刚载入的时候，获取task的模板信息后，构建页面
      var num = count;

      var data = eval(allinformation);
      var facility_name = data.facility_name;
      var maintenance_content = data.maintenance_content;
      var alert_content = data.alert_content;
      var control_content = eval(data.control_content);

      $("#facility_name").html("");
      $("#maintenance_content").html("");
      var facility_name_html = '<div>设施名称： '+facility_name+'</div>';
      var maintenance_content_html = '<div>维保内容： '+maintenance_content+'</div>';
      $("#facility_name").append(facility_name_html);
      $("#maintenance_content").append(maintenance_content_html);
      $("#control_ul"+num).html("");
      var serial_number = '<li class="aui-list-item" style="font-size:24px;">1</li>';
      $("#control_ul"+num).append(serial_number);
      textcontent[num]="";
      videocontent[num]="";
      voicecontent[num]="";
      photocontent[num]="";
      cannottest[num]="";
      for (var i = 0; i < control_content.length; i++) {
        var tempcontrol = control_content[i];

        if (tempcontrol.control_type=="radio") {
          //判断这个radio的上层控件之前是否写过
          var isexist = tempcontrol.control_name+'div'+num;
          if (document.getElementById(isexist)) {
            var tempcontrol_html = '<label><input id="'+tempcontrol.control_id+num+'" class="aui-radio" type="radio" name="'+tempcontrol.control_name+num+'" value="'+tempcontrol.control_value+'"> '+tempcontrol.control_value+'</label>';
             $("#"+isexist).append(tempcontrol_html);
          }
          else {
              var tempcontrol_html = '<li class="aui-list-item"><div id ="'+tempcontrol.control_name+'div'+num+'" class="aui-list-item-inner"><label><input id="'+tempcontrol.control_id+num+'" class="aui-radio" type="radio" name="'+tempcontrol.control_name+num+'" value="'+tempcontrol.control_value+'" > '+tempcontrol.control_value+'</label></div></li>';
              $("#control_ul"+num).append(tempcontrol_html);
          }
        }
        else {
              if (tempcontrol.control_type=="text")
              {
                 var temptexthtml =  '<li class="aui-list-item"><div class="aui-list-item-inner" style="color:'+tempcontrol.control_color+'" name="'+tempcontrol.control_name+num+'">'+tempcontrol.control_value+':</div></li>'
                 $("#control_ul"+num).append(temptexthtml);
              }
              else
              {
                  if (tempcontrol.control_type=="input") {
                      var tempinputhtml = '<div class="aui-list-item-inner"><div class="text-input-form"><div class="input-form-top clearfix"><input id= "'+tempcontrol.control_id+num+'" type="text" style="height:30px;"></div></div></div>';
                     $("#control_ul"+num).append(tempinputhtml);
                  }
                  else {
                    alert("数据好像有问题，这个数据没法解析");
                  }
              }
        }

      }
        var  tempalert_content = '<li class="aui-list-item"><div class="aui-list-item-inner" style="color:#F00;">'+alert_content+':</div></li>';
        $("#control_ul"+num).append(tempalert_content);
        var  tempother = '<li class="aui-list-item"><div class="aui-list-item-inner" align="center"><img class="aligncenter" src="../image/arrows_circle_plus.png" height="40"  width="40" onclick="fnOpenChooseFrame('+num+')"></div></li><li class="aui-list-item"><div class="aui-list-item-inner"><img id="voice'+num+'" style="float:left;margin-left:35px;" src="../image/voice.ico" height="30"  width="30" ><img id="text'+num+'"  style="float:left;margin-left:35px;" src="../image/word.ico" height="30"  width="30" ><img id="video'+num+'" style="float:left;margin-left:35px;" src="../image/video.ico" height="30"  width="30"><img id="image'+num+'" style="float:left;margin-left:35px;" src="../image/Photo.ico" height="30"  width="30" onclick="fnOpenpicture('+num+')"></div></li><li class="aui-list-item"><div class="aui-list-item-inner">测试结果</div></li><li class="aui-list-item"><div class="aui-list-item-inner"><label><input id="normal'+num+'" class="aui-radio" type="radio" name="testresult'+num+'" value="正常" > 正常</label><label><input id="repair'+num+'" class="aui-radio" type="radio" name="testresult'+num+'" value="需要报价维修"> 需要维修报价</label><label><input id="investigation'+num+'" class="aui-radio" type="radio" name="testresult'+num+'" value="需要进一步排查" > 需要进一步排查</label></div></li><li class="aui-list-item"><div class="aui-list-item-inner"><img class="aligncenter" src="../image/delete.png" height="40"  width="40" onclick="deletecontent('+num+')"></div></li><li class="aui-list-item"><div class="aui-list-item-inner"></div></li>';
        $("#control_ul"+num).append(tempother);
        //给“不能测试”这个radio添加点击事件
        $("#testno"+num).click(function(){

            dialogBox.list({
                tapClose: true,
                texts: {
                    title: '请填写不能测试的原因',
                    enter: '提交'
                },
                listTitles: [''],
                styles: {
                    bg: '#fff',
                    corner: 0,
                    w: 300,
                    h: 260,
                    title: {
                        h: 44,
                        size: 14,
                        color: '#000'
                    },
                    list: {
                        h: 60,
                        row: 1,
                        title: {
                            marginL: 10,
                            size: 14,
                            color: '#696969'
                        },
                        content: {
                            marginL: 10,
                            size: 14,
                            color: '#000'
                        }
                    },
                    dividingLine: {
                        width: 0.5,
                        color: '#696969'
                    },
                    enter: {
                        w: 135,
                        h: 55,
                        bg: '#F00',
                        color: '#ffffff',
                        size: 20
                    }
                }
            }, function(ret) {
                if (ret.eventType == 'enter') {
                    cannottest[num]  = ret.amounts;
                    dialogBox.close({
                        dialogName: 'list'
                    });
                    //某个做法
                    alert("不能测试原因已经存储，请继续您的工作");
                    $("#control_ul"+num).html("");
                    var serial_number = '<li class="aui-list-item" style="font-size:24px;">1</li>';
                    $("#control_ul"+num).append(serial_number);
                    var tempcontrol_html = '<li class="aui-list-item"><div id ="testdiv'+num+'" class="aui-list-item-inner"><label><input id="testyes'+num+'" class="aui-radio" type="radio" name="test'+num+'" value="能测试" > 能测试</label><label><input id="testno'+num+'" class="aui-radio" type="radio" name="test'+num+'" value="不能测试" checked disabled>不能测试</label></div></li>';
                    $("#control_ul"+num).append(tempcontrol_html);

                }
            });

        });

    }


    function deletecontent(index){
      //删除图标的响应函数,index表示这是第几个任务的序号
      if (index ==0) {
        alert("这是唯一的测试项目，无法删除");
      }
      else {
        dialogBox.alert({
    texts: {
        content: '确定要删除本项吗',
        leftBtnTitle: '取消',
        rightBtnTitle: '确认'
    },
    styles: {
        bg: '#fff',
        w: 300,
        content: {
            color: '#000',
            size: 14
        },
        left: {
            marginB: 7,
            marginL: 20,
            w: 130,
            h: 35,
            corner: 2,
            bg: '#FFF',
            size: 12
        },
        right: {
            marginB: 7,
            marginL: 10,
            w: 130,
            h: 35,
            corner: 2,
            bg: '#FFF',
            size: 12
        }
    }
}, function(ret) {
    if (ret.eventType == 'left') {
        var dialogBox = api.require('dialogBox');
        dialogBox.close({
            dialogName: 'alert'
        });
    }
    else {
        //确定要删除的话，清空相应的html后，然后把各个数组的东西也删掉
        $("#control_ul"+index).html("");
        textcontent.splice(index,1);
        videocontent.splice(index,1);
        voicecontent.splice(index,1);
        photocontent.splice(index,1);
        count--;
    //    var dialogBox = api.require('dialogBox');
        dialogBox.close({
            dialogName: 'alert'
        });
    }
});
      }
        }

    function fnOpenChooseFrame(temp_count) {
  //点击加号后，四选一，打开文字、照片、视频、语音的函数
      dialogBox.share({
          rect: {
              w: 360,
              h: 260
          },
          items: [{
              text: '照片',
              icon: 'widget://image/Photo.ico'
          }, {
              text: '文字',
              icon: 'widget://image/word.ico'
          }, {
              text: '视频',
              icon: 'widget://image/video.ico'
          }, {
              text: '语音',
              icon: 'widget://image/voice.ico'
          }],
          styles: {
              bg: '#FFF',
              corner: 6,
              column: 4,
              horizontalSpace: 32,
              verticalSpace: 32,
              itemText: {
                  color: '#000',
                  size: 15,
                  marginT: 20
              },
              itemIcon: {
                  size: 45
              }
          },
          tapClose: true
      }, function(ret) {
        var choice=ret.index;
          if (choice == 0) {
          //调用照片的接口
          dialogBox.close ({
              dialogName: 'share'
          });

          addPhotoContent(temp_count);
          }
          else {
            if (choice == 1) {
              //调用文字的接口
              dialogBox.close ({
                  dialogName: 'share'
              });
              addTextContent(temp_count);


            }
            else {
              if (choice==2) {
                //调用视频的接口
                alert("暂不支持视频上传，敬请期待");
              }
              else {
                alert("暂不支持语音上传，敬请期待");
                //调用语音的接口
              }
            }
          }
      });
    }
    var pictureurl;
    var pictureid;
    var picturetime;
    function addPhotoContent(temp_count){
    api.getPicture({
    sourceType: 'camera',
    encodingType: 'jpg',
    mediaValue: 'pic',
    destinationType: 'url',
    allowEdit: true,
    quality: 9,
    saveToPhotoAlbum:false
}, function(ret, err) {
    if (ret) {
      //  $api.setStorage('pictureurl',ret.data);
       //alert(document.getElementById('img1').src);
      //alert(ret.data);
      if(ret.data == ""){
        alert("您取消了拍照");
      }else{
        pictureurl = ret.data;
        var now=new Date();
        var year=now.getFullYear();
        var month=now.getMonth()+1;
        var day=now.getDate();
        var hours=now.getHours();
        var minutes=now.getMinutes();
        var seconds=now.getSeconds();
        var tmp1 = now.toLocaleString( );
        var tmp = year+"/"+month+"/"+day+"/"+hours+"/"+minutes+"/"+seconds;
        var timestamp = Date.parse(new Date());
        // $api.setStorage('picturetime',tmp1);
        picturetime= tmp1;
        // var jsfun = 'picture();';
        // api.execScript({
        //     frameName: 'testpicture',
        //     script: jsfun
        // });
        pictureid = timestamp;
        // $api.setStorage('pictureid',timestamp);
        api.showProgress({
        title: '图片存储中...',
        text: '先喝杯茶...',
        modal: false
    });
        picture(timestamp,temp_count);
      }

    } else {
        alert(JSON.stringify(err));
    }
});
};
    function addTextContent(temp_count)
    {//四选一的文字的函数，用来添加文字,temp_count表示这是第几个任务的序号
      dialogBox.list({
          tapClose: true,
          texts: {
              title: '请填写故障原因',
              enter: '提交'
          },
          listTitles: [''],
          styles: {
              bg: '#fff',
              corner: 0,
              w: 300,
              h: 260,
              title: {
                  h: 44,
                  size: 14,
                  color: '#000'
              },
              list: {
                  h: 60,
                  row: 1,
                  title: {
                      marginL: 10,
                      size: 14,
                      color: '#696969'
                  },
                  content: {
                      marginL: 10,
                      size: 14,
                      color: '#000'
                  }
              },
              dividingLine: {
                  width: 0.5,
                  color: '#696969'
              },
              enter: {
                  w: 135,
                  h: 55,
                  bg: '#F00',
                  color: '#ffffff',
                  size: 20
              }
          }
      }, function(ret) {
          textcontent[temp_count] = ret.amounts;
          if (ret.eventType == 'enter') {
              dialogBox.close({
                  dialogName: 'list'
              });
          }
      });

    }


    function getALLinformation()
    {//这个函数是用来从后台获取task的模板，获取调用creatPage()函数构建第一个页面

      api.ajax({
          url: $api.getStorage('connectUrl') + '/Maintenancer/GetTaskTemplate',//接口地址
          method: 'post',
          data: {
              values: {
                  maintenance_test_content_id:maintenance_test_content_id//参数在正式版替换成maintenance_test_content_id
              }
          }
      },function(ret, err){
          if (ret) {
            var status = ret.status;
               if (status =="true") {
                 allinformation = ret.template;
                 creatPage();
               }
               else {
                 alert("未能与服务器取得连接，请检查网络情况");
                 api.closeWin({
                     name: 'executeTestTask_win'
                 });
               }
          } else {

            api.toast({
                msg: ret.message,
                duration: 2000,
                location: 'bottom'
            });
          }
      });

    };
    function fnOpenpicture(temp_count){
      // var pictureid = $api.getStorage('pictureid');
      //alert(photocontent[temp_count]);
      
      var tempphoto=photocontent[temp_count].substring(1,photocontent[temp_count].length-1);
      photoBrowser.open({
          images: [
              "fs://img/"+tempphoto+".png"
          ],
          bgColor: '#000'
      }, function(ret, err) {
          if (ret) {
              //alert(JSON.stringify(ret));
              if(ret.eventType == "click"){
                photoBrowser.close();
              }
          } else {
              //alert(JSON.stringify(err));
          }
      });
    };
    function picture(timestamp,temp_count){
      // var pictureurl = $api.getStorage('pictureurl');
      var imageFilter = api.require('imageFilter');
      imageFilter.getAttr({
          path: pictureurl
      },function( ret, err ){
          if( ret.status ){
              //alert( JSON.stringify( ret ) );
              // var UILoading = api.require('UILoading');
              // UILoading.flower({
              //     center: {
              //         x: 160,
              //         y: 240
              //     },
              //     size: 30,
              //     fixed: true
              // }, function(ret) {
              //     //alert(JSON.stringify(ret));
              // });
              var cav = document.getElementById('mycanvas');
              cav.width = ret.width;  //设置画布宽度
              cav.height = ret.height;
              ctx = cav.getContext('2d');
              var img = new Image();
              img.src = pictureurl;
            // var tmp = $api.getStorage('picturetime');
              img.onload = function(){
                ctx.drawImage(img,0,0);//将新new出的img对象放入；                          // 绘制水印
             ctx.font="oblique small-caps bold 70px Arial";//设置水印字体大小；字体格式；
             ctx.textAlign = "left";//对其方式；还有其他对其方式；
             ctx.fillStyle = "#ffffff";//颜色
             ctx.fillText(picturetime,60,100);//第一个参数为内容；后两个为x,y坐标；以图片右上角为起点0，0；偏移多少而已；下面相同
            var base64code = cav.toDataURL(pictureurl).replace("data:image/png;base64,", "");
            var base64 = cav.toDataURL(pictureurl);
            //console.log(cav.toDataURL(pictureurl));
            var trans = api.require('trans');
            //console.log(base64code);
            photocontent[temp_count] = '"'+pictureid+'"';
            trans.saveImage({
                base64Str: base64code,
                album: true,
                imgPath:"fs://img/",
                imgName: timestamp+".png"
            }, function(ret, err) {
                if (ret.status) {
                  // UILoading.closeFlower({
                  //      id: id++                                  //关闭id 号对应加载提示框
                  // });
                  alert("图片存储成功，可以点击查看了！");
                  api.hideProgress();
                } else {
                    alert(err.message);
                }
            });
           };
          }else{
              alert(err.message);
          }
      });
    };
    var files1;
    function getPicturecount(){
       var tm = new Array();
      for(var i = 0;i<photocontent.length;i++){
         //tmp = "files"+":"+files;
         var tempphoto=photocontent[i].substring(1,photocontent[i].length-1);
          tm[i]='fs://img/'+tempphoto+'.png';
      //  tm[i] = "fs://img/"+tempphoto+".png";
        files1 = {};
        //alert(tm[i]);
        // var photo = "photo"+i;
        // var files={};
        // files[photo]="fs://img/"+photocontent[i]+".png";
        //var tmp =  { photo :"fs://img/"+photocontent[i]+".png"};

      };
        files1["file"] = tm;
        //alert(JSON.stringify(files1));
    };
</script>
</html>
